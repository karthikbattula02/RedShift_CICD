name: Monitor Webhooks

on:
  push:

jobs:
  check-webhook:
    runs-on: ubuntu-latest
    steps:
      - name: Check webhook delivery for this commit
        id: check
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.WEBHOOK_PAT2 }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const commitSha = context.sha;
            const commitMsg = context.payload.head_commit.message;

            console.log(`🔎 Checking webhook delivery for commit: ${commitSha}`);
            console.log(`💬 Commit message: ${commitMsg}`);

            const hooks = await github.request("GET /repos/{owner}/{repo}/hooks", { owner, repo });
            if (!hooks.data.length) throw new Error("No webhooks found in this repo!");

            const hook = hooks.data.find(h => h.config.url.includes("https://1bf2a1a33060.ngrok-free.app/github-webhook/"));
            if (!hook) throw new Error("No matching webhook found!");
            const hookId = hook.id;

            let deliveries = await github.request("GET /repos/{owner}/{repo}/hooks/{hook_id}/deliveries", {
              owner, repo, hook_id: hookId
            });

            let delivery = deliveries.data.find(d =>
              d.request && d.request.payload && d.request.payload.head_commit?.id === commitSha
            );

            if (!delivery) {
              console.log("⚠️ Delivery not found. Attempting redelivery...");

              // Redeliver the last delivery
              if (deliveries.data.length > 0) {
                const lastDelivery = deliveries.data[0];
                await github.request("POST /repos/{owner}/{repo}/hooks/{hook_id}/deliveries/{delivery_id}/attempts", {
                  owner, repo, hook_id: hookId, delivery_id: lastDelivery.id
                });
                console.log("🔁 Redelivery requested. Waiting 5 seconds...");
                await new Promise(r => setTimeout(r, 5000));

                deliveries = await github.request("GET /repos/{owner}/{repo}/hooks/{hook_id}/deliveries", {
                  owner, repo, hook_id: hookId
                });

                delivery = deliveries.data.find(d =>
                  d.request && d.request.payload && d.request.payload.head_commit?.id === commitSha
                );
              }
            }

            const finalStatus = delivery?.status || "not found";
            console.log(`📦 Final webhook status for commit: ${finalStatus}`);

            if (!delivery || delivery.status !== "ok") {
              core.setFailed(`❌ Webhook failed or not delivered for commit ${commitSha} (status: ${finalStatus})`);
            }

      - name: Send mail on failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "❌ Webhook failed for commit ${{ github.sha }}"
          to: photoskarthik2@gmail.com
          from: GitHub Actions <${{ secrets.MAIL_USERNAME }}>
          body: |
            Webhook failed or not delivered.

            📌 Repository: ${{ github.repository }}
            🔗 Commit SHA: ${{ github.sha }}
            💬 Commit Message: ${{ github.event.head_commit.message }}
            📦 Webhook final status: ${finalStatus}
