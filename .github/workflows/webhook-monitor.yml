name: Monitor Webhook Failures

on:
  push:
    branches:
      - main

jobs:
  check-webhook:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      repository-hooks: write   # ‚úÖ correct spelling

    steps:
      - name: Check webhook delivery status
        id: check-webhook
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.WEBHOOK_PAT }}
          script: |
            const { data: hooks } = await github.rest.repos.listWebhooks({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            if (hooks.length === 0) {
              core.setFailed("‚ùå No webhooks found for this repo");
            } else {
              const hook = hooks[0]; // first webhook
              const deliveries = await github.rest.repos.listWebhookDeliveries({
                owner: context.repo.owner,
                repo: context.repo.repo,
                hook_id: hook.id
              });

              if (deliveries.data.length === 0) {
                core.setFailed("‚ùå No deliveries found for webhook");
              } else {
                const last = deliveries.data[0];
                core.info(`üîç Last delivery status: ${last.status}`);

                // ‚úÖ "not equals to" condition
                if (last.status !== "OK") {
                  core.setFailed(`‚ùå Webhook delivery failed (status: ${last.status})`);
                } else {
                  core.info("‚úÖ Webhook delivered successfully");
                }
              }
            }
