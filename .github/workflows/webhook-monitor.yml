name: Monitor Webhooks
 
on:

  push:

    branches: [main]
 
jobs:

  check-webhook:

    runs-on: ubuntu-latest

    steps:

      - name: Check webhook delivery

        uses: actions/github-script@v6

        with:

          github-token: ${{ secrets.WEBHOOK_PAT }}

          script: |

            const owner = context.repo.owner;

            const repo = context.repo.repo;

            const hookId = 558736907
 
            const { data: deliveries } = await github.request(

              "GET /repos/{owner}/{repo}/hooks/{hook_id}/deliveries",

              { owner, repo, hook_id: hookId }

            );
 
            const latest = deliveries[0];

            console.log("Latest delivery:", latest);
 
            if (latest.status === "timed_out") {

              console.log(`Webhook delivery ${latest.id} timed out. Retrying...`);

              await github.request(

                "POST /repos/{owner}/{repo}/hooks/{hook_id}/deliveries/{delivery_id}/attempts",

                { owner, repo, hook_id: hookId, delivery_id: latest.id }

              );

              console.log(`Redelivery triggered for ${latest.id}`);

            } else {

              console.log(`Webhook delivery ${latest.id} status: ${latest.status}`);

            }
            
      - name: Send mail
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORd }}
          subject: "GitHub Workflow Notification"
          to: "photoskarthik2@gmail.com"
          from: "karthikknvamma@gmail.com"
          body: "A new commit has been pushed to main."
