name: Monitor Webhooks

on:
  push:

jobs:
  check-webhook:
    runs-on: ubuntu-latest
    steps:
      - name: Check webhook delivery for this commit
        id: check
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.WEBHOOK_PAT2 }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const commitSha = context.sha;
            const commitMsg = context.payload.head_commit.message;

            console.log(`ğŸ” Checking webhook delivery for commit: ${commitSha}`);
            console.log(`ğŸ’¬ Commit message: ${commitMsg}`);

            // Get all webhooks
            const hooks = await github.request("GET /repos/{owner}/{repo}/hooks", {
              owner, repo
            });

            if (!hooks.data.length) {
              throw new Error("No webhooks found in this repo!");
            }

            // Pick the correct webhook by URL (update YOUR_WEBHOOK_URL)
            const hook = hooks.data.find(h => h.config.url.includes("https://1bf2a1a33060.ngrok-free.app/github-webhook/"));
            if (!hook) throw new Error("No matching webhook found!");
            const hookId = hook.id;

            // Wait a few seconds to let the delivery be registered
            await new Promise(r => setTimeout(r, 3000));

            // Get deliveries for that hook
            let deliveries = await github.request("GET /repos/{owner}/{repo}/hooks/{hook_id}/deliveries", {
              owner, repo, hook_id: hookId
            });

            // Match delivery by commit SHA (head_commit.id)
            let delivery = deliveries.data.find(d => 
              d.request && d.request.payload && d.request.payload.head_commit?.id === commitSha
            );

            if (!delivery) {
              console.log(`âš ï¸ No delivery found for commit ${commitSha}. It may not have triggered yet.`);
              return;
            }

            console.log(`ğŸ“¦ Webhook status: ${delivery.status}`);

            if (delivery.status !== "ok") {
              console.log("âš ï¸ Webhook failed, attempting redelivery...");

              // Redeliver
              await github.request("POST /repos/{owner}/{repo}/hooks/{hook_id}/deliveries/{delivery_id}/attempts", {
                owner, repo, hook_id: hookId, delivery_id: delivery.id
              });

              // Wait before checking again
              await new Promise(r => setTimeout(r, 5000));

              // Fetch deliveries again
              deliveries = await github.request("GET /repos/{owner}/{repo}/hooks/{hook_id}/deliveries", {
                owner, repo, hook_id: hookId
              });

              delivery = deliveries.data.find(d => 
                d.request && d.request.payload && d.request.payload.head_commit?.id === commitSha
              );

              console.log(`ğŸ” After retry, webhook status: ${delivery?.status || "not found"}`);

              if (!delivery || delivery.status !== "ok") {
                core.setFailed(`âŒ Webhook failed even after retry for commit ${commitSha}`);
              }
            } else {
              console.log("âœ… Webhook succeeded");
            }

      - name: Send mail on failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âŒ Webhook failed for commit ${{ github.sha }}"
          to: photoskarthik2@gmail.com
          from: GitHub Actions <${{ secrets.MAIL_USERNAME }}>
          body: |
            Webhook failed even after retry.

            ğŸ“Œ Repository: ${{ github.repository }}
            ğŸ”— Commit SHA: ${{ github.sha }}
            ğŸ’¬ Commit Message: ${{ github.event.head_commit.message }}
