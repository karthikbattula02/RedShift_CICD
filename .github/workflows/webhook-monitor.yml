name: Monitor Webhook Failures

on:
  workflow_dispatch:   # allow manual run
  push:
    branches:
      - main

jobs:
  check-webhook:
    runs-on: ubuntu-latest
    steps:
      - name: Check webhook delivery status
        id: check-webhook
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.WEBHOOK_PAT }}
          script: |
            const repo = context.repo.repo;
            const owner = context.repo.owner;
            const { data: deliveries } = await github.request(
              "GET /repos/{owner}/{repo}/hooks/{hook_id}/deliveries",
              {
                owner,
                repo,
                hook_id: process.env.WEBHOOK_ID
              }
            );

            const latest = deliveries[0];
            const status = latest?.status || "unknown";
            const message = `Webhook delivery ${latest?.id} status: ${status}`;

            core.setOutput("status", status);
            core.setOutput("mail_context", message);

      - name: Send mail
        if: ${{ steps.check-webhook.outputs.status != 'ok' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "GitHub Workflow Notification"
          to: "photoskarthik2@gmail.com"
          from: "karthikknvamma@gmail.com"
          body: ${{ steps.check-webhook.outputs.mail_context }}
