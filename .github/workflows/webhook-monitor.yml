name: Monitor Webhook Failures

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  check-webhook:
    runs-on: ubuntu-latest
    steps:
      - name: Check webhook delivery status
        id: check-webhook
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.WEBHOOK_PAT }}
          script: |
            const repo = context.repo.repo;
            const owner = context.repo.owner;

            // Get all hooks
            const hooks = await github.rest.repos.listWebhooks({
              owner,
              repo,
            });

            if (hooks.data.length === 0) {
              core.setOutput("mail_body", "No webhooks found in the repo.");
              return;
            }

            const hookId = hooks.data[0].id;

            // Get deliveries for the hook
            const deliveries = await github.request(
              `GET /repos/${owner}/${repo}/hooks/${hookId}/deliveries`,
              { per_page: 5 }
            );

            let resultMsg = "";
            for (const delivery of deliveries.data) {
              if (delivery.status_code !== 200) {
                // Redeliver
                await github.request(
                  `POST /repos/${owner}/${repo}/hooks/${hookId}/deliveries/${delivery.id}/attempts`
                );
                resultMsg += `❌ Delivery ${delivery.id} failed (status: ${delivery.status_code}). Retried.\n`;
              } else {
                resultMsg += `✅ Delivery ${delivery.id} succeeded (status: ${delivery.status_code}).\n`;
              }
            }

            core.setOutput("mail_body", resultMsg);

      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "GitHub Webhook Delivery Report"
          to: "photoskarthik2@gmail.com"
          from: "GitHub Actions <${{ secrets.EMAIL_USER }}>"
          body: ${{ steps.check-webhook.outputs.mail_body }}
