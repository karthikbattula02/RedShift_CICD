name: Monitor Webhooks

on:
  push:
    branches: [main]

jobs:
  check-webhook:
    runs-on: ubuntu-latest
    steps:
      - name: Get latest commit info
        id: commit_info
        run: |
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "msg=$(git log -1 --pretty=%B)" >> $GITHUB_ENV

      - name: Check webhook delivery
        id: webhook_status
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.WEBHOOK_PAT2 }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Fetch repo hooks
            const hooks = await github.request("GET /repos/{owner}/{repo}/hooks", {
              owner, repo
            });

            if (!hooks.data.length) {
              core.setFailed("No webhooks found in this repo");
            }

            const hookId = hooks.data[0].id;

            // Fetch deliveries for this hook
            const deliveries = await github.request("GET /repos/{owner}/{repo}/hooks/{hook_id}/deliveries", {
              owner, repo, hook_id: hookId
            });

            const latest = deliveries.data[0];

            console.log("Latest webhook delivery:", latest);

            const statusCode = latest.response?.status || latest.response?.code || "unknown";

            core.setOutput("status", statusCode);
            core.setOutput("hook_id", hookId);

      - name: Send Email if Webhook Failed
        if: steps.webhook_status.outputs.status != '200'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚ùå Webhook Failed for commit ${{ env.sha }}"
          to: "yourmail@example.com"
          from: "GitHub Actions <${{ secrets.MAIL_USERNAME }}>"
          body: |
            Webhook delivery failed üö®

            Repository: ${{ github.repository }}
            Commit SHA: ${{ env.sha }}
            Commit Message: ${{ env.msg }}

            Webhook ID: ${{ steps.webhook_status.outputs.hook_id }}
            Status Code: ${{ steps.webhook_status.outputs.status }}

      - name: Send Email if Webhook Succeeded
        if: steps.webhook_status.outputs.status == '200'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚úÖ Webhook Succeeded for commit ${{ env.sha }}"
          to: "yourmail@example.com"
          from: "GitHub Actions <${{ secrets.MAIL_USERNAME }}>"
          body: |
            Webhook delivery succeeded üéâ

            Repository: ${{ github.repository }}
            Commit SHA: ${{ env.sha }}
            Commit Message: ${{ env.msg }}

            Webhook ID: ${{ steps.webhook_status.outputs.hook_id }}
            Status Code: ${{ steps.webhook_status.outputs.status }}
